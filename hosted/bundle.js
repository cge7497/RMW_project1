(()=>{"use strict";const e=(e,t,o,a,n,l,i=!0)=>{a&&(n*=-1),i&&o.clearRect(0,0,640,480),o.save(),o.beginPath(),o.arc(e,t-3*n,3,0,2*Math.PI),o.moveTo(e,t),o.lineTo(e,t+5*n),o.lineTo(e-2*n,t+8*n),o.moveTo(e,t+5*n),o.lineTo(e+2*n,t+8*n),o.moveTo(e-3*n,t+3*n),o.lineTo(e+3*n,t+3*n),l&&(o.strokeStyle=l),o.stroke(),o.closePath(),o.restore()},t=(e,t,o,a,n,l,i)=>{n.save(),n.beginPath(),n.moveTo(e,t),n.lineTo(e+o,t),n.lineTo(e+o,t+a),n.lineTo(e,t+a),n.closePath(),i?(n.fillStyle=l,n.fill()):(n.strokeStyle=l,n.lineWidth=3,n.stroke()),n.restore()},o=async(e,t)=>{const o=`name=${e}&item=${t}`;(async e=>{let t;switch(e.status){case 200:t=await e.json();break;case 204:break;default:console.error(t)}})(await fetch("/updateItems",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:o}))};class a{constructor(e,t,o,a,n){this.x=e,this.y=t,this.width=o,this.height=a,this.color=n,this.hSpeed=a*o/15,this.vSpeed=0}}const n=[{x:280,y:315,width:31,height:30,color:"red"},{x:0,y:0,width:30,height:800,color:"blue"},{x:0,y:950,width:30,height:502,color:"blue"},{x:-200,y:801,width:30,height:30,color:"red"},{x:-200,y:700,width:200,height:50,color:"blue"},{x:-200,y:998,width:200,height:50,color:"blue"},{x:-650,y:700,width:200,height:50,color:"blue"},{x:-650,y:998,width:200,height:50,color:"blue"},{x:-650,y:750,width:50,height:250,color:"blue"},{x:1e3,y:36,width:30,height:1494,color:"green"},{x:0,y:1500,width:1030,height:30,color:"black"},{x:-700,y:1500,width:700,height:30,color:"yellow"},{x:0,y:0,width:1030,height:30,color:"orange"}],l=[{x:-540,y:982,width:16,height:16,id:"screwattack"},{x:-600,y:1484,width:16,height:16,id:"morphball"},{x:296,y:-16,width:16,height:16,id:"yellowswitch"}];let i,h,c;const r=[],s={};let d={},y=0,w=0;const m={screwattack:document.getElementById("screwattack"),morphball:document.getElementById("morphball"),yellowswitch:document.getElementById("yellowswitch")},g={screwattack:{obtained:!1,collected:F},morphball:{obtained:!1,collected:D},yellowswitch:{collected:_}},u={x:300,y:300,halfWidth:4,halfHeight:7,newX:300,newY:300,scale:1,name:""};let p,f,x,b,v=0,k=0,S=!1,T=!0,E=!1,M=!1,H=!1,$=!1,I=0,C=[],L=0,W=0,X=0;const Y=()=>{M?_():(B(),e(u.x+W,u.y+X,h,S,u.scale)),P()},B=()=>{let e=0,t=0;C[65]&&(e=-2),C[68]&&(e=2),t=S?-3:3,H?C[87]&&(X-=((e,t)=>{let o=4,a=0;return t&&(o=-4),1===e.scale?(e.scale=.1,e.halfWidth=1,e.halfHeight=1,a=-o):(e.scale=1,e.halfWidth=4,e.halfHeight=7,a=-3*o),e.y+=a,a})(u,S),H=!1,I=30,e=0,t=0):$&&(I-=1,I<=0&&(H=!0)),u.newX=u.x+e,u.newY=u.y+t,A(u,e,t)?(W+=u.x-u.newX,X+=u.y-u.newY,u.x=u.newX,u.y=u.newY):(u.x+=e,u.y+=t,W-=e,X-=t),R(u)},P=()=>{n.forEach((e=>{t(e.x+W,e.y+X,e.width,e.height,h,e.color,!0)})),l.forEach((e=>{h.drawImage(m[e.id],e.x+W,e.y+X)}))},j=()=>{c.clearRect(0,0,640,480),t(0,0,p,f,c,"white",!0),L+=0,r.forEach((function(e){e.hSpeed=1*Math.cos(L),e.vSpeed=1*Math.sin(L),e.x+=e.hSpeed,e.y+=e.vSpeed,e.x>p+20?e.x=-20:e.x<-20&&(e.x=p+20),e.y>f+20?e.y=-20:e.y<-20&&(e.y=f+20),t(e.x,e.y,e.width,e.height,c,e.color,!0)}))},q=async()=>{s&&!M&&(d=await(async e=>{const t=`movement=${JSON.stringify(e)}`;let o=await fetch("/addMovement",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:t}),a=await o.json();switch(o.status){case 200:a=await o.json();break;case 204:break;default:console.error(a)}return a})(s),s.movement=[],y=0,w=0)},O=()=>{if(M)return;let t;s.movement.push({x:u.x,y:u.y,flipped:S}),w+=1,d.movement&&(t=Object.keys(d.movement),t.splice(t.indexOf(u.name),1),t.length<1||(i.clearRect(0,0,640,480),t.forEach((t=>{const o=d.movement[t].movement[y];o&&e(o.x+W,o.y+X,i,o.flipped,1,`${d.movement[t].color}55`,!1)})),y+=1))},A=(e,t,o)=>{let a=!1;return n.forEach((n=>{e.newX-e.halfWidth<n.x+n.width&&e.newX+e.halfWidth>n.x&&e.newY-e.halfHeight<n.y+n.height&&e.newY+e.halfHeight>n.y&&(a=!0,((e,t)=>e.y+e.halfHeight<t.y&&e.newY+e.halfHeight>=t.y)(e,n)||((e,t)=>e.y-e.halfHeight>=t.y+t.height&&e.newY-e.halfHeight<t.y+t.height)(e,n)?(e.newY-=o,E||(T=!0)):(((e,t)=>e.x-e.halfWidth>=t.x+t.width&&e.newX-e.halfWidth<t.x+t.width)(e,n)||((e,t)=>e.x+e.halfWidth<=t.x&&e.newX+e.halfWidth>=t.x)(e,n))&&(e.newX-=t))})),a},R=e=>{l.forEach((t=>{e.newX-e.halfWidth<t.x+t.width&&e.newX+e.halfWidth>t.x&&e.newY-e.halfHeight<t.y+t.height&&e.newY+e.halfHeight>t.y&&(g[t.id].collected(),l.splice(l.indexOf(t),1))}))};function D(e=!0){document.getElementById("morphball").style.display="inline",document.getElementById("moveInstructions").innerHTML="Use '<strong>A</strong>', '<strong>D</strong>', and '<strong>W</strong>' to move, ",H=!0,$=!0,!0===e&&(o(u.name,"morphball"),b.play())}function F(e=!0){document.getElementById("screwattack").style.display="inline",document.getElementById("spaceInstructions").innerHTML="<strong>SPACE</strong> to ultra flip",E=!0,!0===e&&(o(u.name,"screwattack"),b.play())}function _(){M||(r.push(new a(640*Math.random(),480*Math.random(),10*Math.random()+30,4*Math.random()+3,v)),x.play(),M=!0),k<254&&(k+=.2),e(u.x+W,u.y+X,h,S,u.scale,`#000000${(255-k).toString(16).substring(0,2)}`),r.forEach((e=>{r.indexOf(e)!=r.length-1?e.color=`rgba(${k}, ${k}, ${k}, 0.1)`:e.color=`${v}${k.toString(16).substring(0,2)}`})),n.forEach((e=>{e.color=`rgba(${k}, ${k}, ${k}, 0.5)`}))}const N=e=>{switch(e.keyCode){case 65:case 68:C[e.keyCode]=!0;break;case 87:H&&(C[e.keyCode]=!0);break;case 32:e.preventDefault(),C[e.keyCode]||(T||E)&&(S=!S,T=!1),C[e.keyCode]=!0}},G=e=>{switch(e.keyCode){case 65:case 68:case 87:case 32:C[e.keyCode]=!1}},J=async t=>{const o=t.querySelector("#nameField").value,n=`name=${o}&age=&color=${t.querySelector("#colorField").value}`;(async(t,o)=>{const n=document.querySelector("#createResponse");let l=!0;switch(t.status){case 200:n.innerHTML=`<b>Logged in as existing user ${o}</b>`;break;case 201:n.innerHTML=`<b>Now playing as new player ${o}</b>`;break;case 400:n.innerHTML="<b>Bad Login Request</b>",l=!1;break;default:n.innerHTML="Error code not implemented by client.",l=!1}const d=await t.json();if(d.message&&(n.innerHTML+=`<p>${d.message}</p>`),l){const t=document.getElementById("submitBtn");t.value="Logged in",t.disabled=!0,d&&((t,o)=>{t&&t.player?(u.name=t.player.name,v=t.player.color,t.player.items&&function(e){e.morphball&&D(!1),e.screwattack&&F(!1)}(t.player.items)):u.name=o,s.name=u.name,s.color=v,s.movement=[],x=new Audio("buttonClick.wav"),x.volume=.25,b=new Audio("itemGet.wav"),b.volume=.25;let n=document.querySelector("#canvas_player"),l=document.querySelector("#canvas_walkers"),d=document.querySelector("#canvas_bg");i=l.getContext("2d"),h=n.getContext("2d"),c=d.getContext("2d"),p=l.width,f=l.height,document.addEventListener("keydown",N),document.addEventListener("keyup",G),e(300,300,h,!1);for(let e=0;e<10;e++)r.push(new a(640*Math.random(),480*Math.random(),10*Math.random()+30,4*Math.random()+3,"rgba(0,0,0,0.3)"));j(),i.fillStyle="black",u.x=u.y=300,setInterval(Y,1e3/60),setInterval(j,1e3/15),setInterval(q,1e3),setInterval(O,1e3/30)})(d,o)}})(await fetch("/addPlayer",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:n}),o)};window.onload=()=>{const e=document.querySelector("#playerForm");e.addEventListener("submit",(t=>(t.preventDefault(),J(e),!1)))}})();